name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Check PR title
      uses: deepakputra/action-pr-title@master
      with:
        regex: '^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?!?: .{1,50}'
        allowed_prefixes: 'feat,fix,docs,style,refactor,perf,test,chore,ci,build'
        disallowed_prefixes: 'wip,WIP'

    - name: Check for breaking changes
      run: |
        # Check if CHANGELOG.md was updated
        if ! git diff origin/main HEAD --name-only | grep -q CHANGELOG.md; then
          echo "⚠️  Consider updating CHANGELOG.md"
        fi

  lint-and-format:
    runs-on: ubuntu-latest
    needs: validate-pr

    steps:
    - uses: actions/checkout@v3

    - name: Check file permissions
      run: |
        echo "Checking for executable scripts..."
        find . -type f \( -name "*.sh" -o -name "*.ps1" \) -not -path "./.git/*" | head -20

    - name: Validate JSON files
      run: |
        echo "Validating JSON configuration files..."
        find . -name "*.json" -not -path "*/node_modules/*" -not -path "./.git/*" | while read f; do
          python3 -m json.tool "$f" > /dev/null && echo "✓ $f" || echo "✗ $f"
        done

    - name: Validate YAML (docker-compose)
      run: |
        echo "Validating docker-compose.yml..."
        docker-compose config > /dev/null && echo "✓ docker-compose.yml is valid" || echo "✗ docker-compose.yml is invalid"

  documentation:
    runs-on: ubuntu-latest
    needs: validate-pr

    steps:
    - uses: actions/checkout@v3

    - name: Check documentation updates
      run: |
        echo "Checking if documentation needs updates..."
        # This is a placeholder - add real checks as needed
        if git diff origin/main HEAD --name-only | grep -E 'src/|backend/|frontend/' > /dev/null; then
          echo "ℹ️  Consider updating relevant documentation"
        fi

        # Check README exists
        if [ -f README.md ]; then
          echo "✓ README.md found"
        else
          echo "✗ README.md not found"
          exit 1
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: validate-pr

    steps:
    - uses: actions/checkout@v3

    - name: Run security scan
      run: |
        echo "Running security checks..."
        # Check for hardcoded secrets
        if grep -r "password\|secret\|api_key\|token" . --include="*.py" --include="*.js" --include="*.ts" | grep -v "node_modules" | grep -v ".git"; then
          echo "⚠️  Warning: Found potential hardcoded secrets in code"
        fi

    - name: Check for common vulnerabilities
      run: |
        echo "Checking for common vulnerability patterns..."
        # Add your security check patterns here
        echo "✓ Security scan completed"
