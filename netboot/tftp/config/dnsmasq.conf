port=69
enable-tftp
tftp-root=/data/tftp
user=nobody
group=nogroup
log-facility=/dev/stdout
log-queries

# ===============================================
# TFTP ONLY Configuration (Minimal)
# ===============================================
# DHCP is handled by Unifi router only
# dnsmasq provides TFTP service ONLY for boot files
# 
# Unifi Configuration:
# - Option 66 (TFTP Server): 192.168.1.50
# - Option 67 (Boot Filename): undionly.kpxe
# ===============================================

# NO DHCP - router handles it exclusively

# ===============================================
# PXE/UEFI Boot Detection
# ===============================================
dhcp-match=set:bios,option:client-arch,0          # BIOS x86
dhcp-match=set:efi32,option:client-arch,6         # UEFI 32-bit
dhcp-match=set:efibc,option:client-arch,7         # UEFI BC
dhcp-match=set:efi64,option:client-arch,9         # UEFI 64-bit
dhcp-match=set:arm64,option:client-arch,0x0b      # ARM64

# iPXE capability detection
dhcp-match=set:ipxe,175

# ===============================================
# Boot File Delivery Chain (Dynamic Based on Client)
# ===============================================

# IMPORTANT: PXE clients cannot directly load iPXE scripts!
# We must use a two-stage boot chain:
# Stage 1: Send actual bootloader (undionly.kpxe/ipxe.efi)
# Stage 2: After bootloader loads, iPXE does DHCP again → we detect it and serve boot.ipxe

# When iPXE client (detected by option 175) requests DHCP:
# → Serve boot.ipxe instead of undionly.kpxe (prevents infinite loop)
dhcp-boot=tag:ipxe,boot.ipxe

# For BIOS/UEFI PXE clients (first stage, no iPXE yet):
# → Send the actual bootloader
dhcp-boot=tag:bios,undionly.kpxe
dhcp-boot=tag:efi64,ipxe.efi
dhcp-boot=tag:efi32,ipxe.efi
dhcp-boot=tag:efibc,ipxe.efi


