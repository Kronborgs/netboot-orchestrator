port=69
enable-tftp
tftp-root=/data/tftp
user=nobody
group=nogroup
log-facility=/dev/stdout
log-queries

# ===============================================
# DHCP Server Configuration
# ===============================================
# Enable DHCP to respond to iPXE Stage 2 DHCP requests
# This activates dhcp-boot rules which serve boot.ipxe to iPXE clients

# CRITICAL: Enable explicit interface binding for DHCP
# dnsmasq must bind to the network interfaces to respond to DHCP
interface=eth0

# Primary VLAN (192.168.1.0/24) DHCP range
dhcp-range=192.168.1.100,192.168.1.200,255.255.255.0,24h

# Boot VLAN (10.10.50.0/24) DHCP range (requires DHCP relay from router to 192.168.1.50:67)
dhcp-range=10.10.50.100,10.10.50.200,255.255.255.0,24h

# Default gateway
dhcp-option=option:router,192.168.1.1

# DNS servers
dhcp-option=option:dns-server,8.8.8.8,8.8.4.4

# DHCP lease time
dhcp-option=option:lease-time,86400

# ===============================================
# PXE/UEFI Boot Detection
# ===============================================
dhcp-match=set:bios,option:client-arch,0          # BIOS x86
dhcp-match=set:efi32,option:client-arch,6         # UEFI 32-bit
dhcp-match=set:efibc,option:client-arch,7         # UEFI BC
dhcp-match=set:efi64,option:client-arch,9         # UEFI 64-bit
dhcp-match=set:arm64,option:client-arch,0x0b      # ARM64

# iPXE capability detection
dhcp-match=set:ipxe,175

# ===============================================
# Boot File Delivery Chain (Dynamic Based on Client)
# ===============================================

# IMPORTANT: PXE clients cannot directly load iPXE scripts!
# We must use a two-stage boot chain:
# Stage 1: Send actual bootloader (undionly.kpxe/ipxe.efi)
# Stage 2: After bootloader loads, iPXE does DHCP again → we detect it and serve boot.ipxe

# When iPXE client (detected by option 175) requests DHCP:
# → Serve boot.ipxe instead of undionly.kpxe (prevents infinite loop)
dhcp-boot=tag:ipxe,boot.ipxe

# For BIOS/UEFI PXE clients (first stage, no iPXE yet):
# → Send the actual bootloader
dhcp-boot=tag:bios,undionly.kpxe
dhcp-boot=tag:efi64,ipxe.efi
dhcp-boot=tag:efi32,ipxe.efi
dhcp-boot=tag:efibc,ipxe.efi


