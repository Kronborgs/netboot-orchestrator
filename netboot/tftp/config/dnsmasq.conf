port=69
enable-tftp
tftp-root=/data/tftp
user=nobody
group=nogroup
log-dhcp
log-facility=/dev/stdout

# ===============================================
# DHCP Configuration
# ===============================================
# Enable DHCP to properly handle iPXE boot chain
# iPXE requires DHCP twice:
# 1. First request: Client asks for boot file -> gets undionly.kpxe
# 2. After chainload: Client asks again -> gets boot.ipxe
#
# This ensures full control over boot file sequence
# ===============================================

# DHCP Server Range (adjust to your network!)
dhcp-range=10.10.50.6,10.10.50.254,12h

# DHCP Options
dhcp-option=3,10.10.50.1                       # Default gateway
dhcp-option=6,10.10.50.1,8.8.8.8               # DNS servers
dhcp-option=66,192.168.1.50                     # TFTP Server IP (Unraid @192.168.1.50 - routable from 10.10.50.0/24)

# ===============================================
# PXE/UEFI Boot Detection
# ===============================================
dhcp-match=set:bios,option:client-arch,0          # BIOS x86
dhcp-match=set:efi32,option:client-arch,6         # UEFI 32-bit
dhcp-match=set:efibc,option:client-arch,7         # UEFI BC
dhcp-match=set:efi64,option:client-arch,9         # UEFI 64-bit
dhcp-match=set:arm64,option:client-arch,0x0b      # ARM64

# iPXE capability detection
dhcp-match=set:ipxe,175

# ===============================================
# Boot File Delivery Chain
# ===============================================

# IMPORTANT: PXE clients cannot directly load iPXE scripts!
# We must use a two-stage boot chain:
# Stage 1: Send actual bootloader (undionly.kpxe/ipxe.efi)
# Stage 2: After bootloader chainloads, send interactive menu

# Detect client architecture for correct bootloader
dhcp-match=set:bios,option:client-arch,0          # BIOS x86
dhcp-match=set:efi32,option:client-arch,6         # UEFI 32-bit
dhcp-match=set:efibc,option:client-arch,7         # UEFI BC
dhcp-match=set:efi64,option:client-arch,9         # UEFI 64-bit
dhcp-match=set:arm64,option:client-arch,0x0b      # ARM64

# iPXE capability detection (second request after bootloader)
dhcp-match=set:ipxe,175

# Stage 1: Non-iPXE clients get bootloader (PXE BIOS request)
dhcp-boot=tag:!ipxe,tag:bios,undionly.kpxe
dhcp-boot=tag:!ipxe,tag:efi64,ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi32,ipxe.efi
dhcp-boot=tag:!ipxe,tag:arm64,ipxe-armel.efi

# Stage 2: iPXE clients get interactive menu script (after chainload)
dhcp-boot=tag:ipxe,boot-menu.ipxe
